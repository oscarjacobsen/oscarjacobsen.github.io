<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>OJ - Space-Time</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }

        #topbar {
            background: #fff;
            padding: 10px;
        }

        .action-button {
            font-size: 16px;
            background-color: transparent;
            border: 1px solid #d3d3d3;
            color: #6e6e6e;
            height: 32px;
            width: 32px;
            text-align: center;
            box-shadow: 0 0 1px rgba(0, 0, 0, 0.3);
        }

        .action-button:hover,
        .action-button:focus {
            background: #0079c1;
            color: #e4e4e4;
        }

        .active {
            background: #0079c1;
            color: #e4e4e4;
        }
        div#dropZone {
            background: gray;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            opacity: 0.6;
            visibility: hidden;
        }
    </style>

    <!-- Legger til ArcGIS API for Javascript -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.23/"></script>

    <!-- 
        Legger til 
        Kilde: http://3d.kommunekart.com/
    
    <link href="/Css/leaflet.css" rel="stylesheet">
    <link href="/Css/NORKART3D.css" rel="stylesheet">
    <script src="/Script/NORKART3D-min.js"></script>
    -->
    <script>
        // Legger til brukte biblioteker
        require([
            "esri/Map",
            "esri/views/SceneView",
            "esri/widgets/Search",
            "esri/widgets/DirectLineMeasurement3D",
            "esri/widgets/AreaMeasurement3D",
            "esri/widgets/Locate",
            "esri/core/promiseUtils",
            "esri/widgets/BasemapToggle",
            "esri/layers/TileLayer",
            "esri/layers/SceneLayer",
            "esri/layers/WMSLayer"
        ], (
            Map,
            SceneView,
            Search,
            DirectLineMeasurement3D,
            AreaMeasurement3D,
            Locate,
            promiseUtils,
            TileLayer,
            SceneLayer,
            WMSLayer
        ) => {
            let activeWidget = null;


            // Lager kart
            const map = new Map({
                basemap: "satellite",
                ground: "world-elevation"
            });

            // Lager 3DScene view
            const view = new SceneView({
                container: "viewDiv",
                map: map,
                //center: [9, 62],
                zoom: 1,
                //camera: {
                //    position: [10.7274104, 59.9170566],
                //    tilt: 80,
                //    heading: 122
                //}
            });

            // add the toolbar for the measurement widgets
            view.ui.add("topbar", "top-right");

            const locate = new Locate({
                view: view,
                useHeadingEnabled: false,
                goToOverride: function (view, options) {
                    options.target.scale = 1500;
                    return view.goTo(options.target);
                }
            });
            view.ui.add(locate, "bottom-right");

            document
                .getElementById("distanceButton")
                .addEventListener("click", (event) => {
                    setActiveWidget(null);
                    if (!event.target.classList.contains("active")) {
                        setActiveWidget("distance");
                    } else {
                        setActiveButton(null);
                    }
                });

            document
                .getElementById("areaButton")
                .addEventListener("click", (event) => {
                    setActiveWidget(null);
                    if (!event.target.classList.contains("active")) {
                        setActiveWidget("area");
                    } else {
                        setActiveButton(null);
                    }
                });

            function setActiveWidget(type) {
                switch (type) {
                    case "distance":
                        activeWidget = new DirectLineMeasurement3D({
                            view: view
                        });

                        // skip the initial 'new measurement' button
                        activeWidget.viewModel.start().catch((error) => {
                            if (promiseUtils.isAbortError(error)) {
                                return; // don't display abort errors
                            }
                            throw error; // throw other errors since they are of interest
                        });

                        view.ui.add(activeWidget, "top-right");
                        setActiveButton(document.getElementById("distanceButton"));
                        break;
                    case "area":
                        activeWidget = new AreaMeasurement3D({
                            view: view
                        });

                        // skip the initial 'new measurement' button
                        activeWidget.viewModel.start().catch((error) => {
                            if (promiseUtils.isAbortError(error)) {
                                return; // don't display abort errors
                            }
                            throw error; // throw other errors since they are of interest
                        });

                        view.ui.add(activeWidget, "top-right");
                        setActiveButton(document.getElementById("areaButton"));
                        break;
                    case null:
                        if (activeWidget) {
                            view.ui.remove(activeWidget);
                            activeWidget.destroy();
                            activeWidget = null;
                        }
                        break;
                }
            }

            function setActiveButton(selectedButton) {
                // focus the view to activate keyboard shortcuts for sketching
                view.focus();
                const elements = document.getElementsByClassName("active");
                for (let i = 0; i < elements.length; i++) {
                    elements[i].classList.remove("active");
                }
                if (selectedButton) {
                    selectedButton.classList.add("active");
                }
            }

            // Legger til Norske Bygninger fra FKB i 3D
            let GeosceneBygninger2Layer = new SceneLayer({
                // URL to the service
                url: "https://utility.arcgis.com/usrsvcs/servers/96c6d88fc74c4117a522bf1ef952ed86/rest/services/Geoscene/GeosceneBygning2/SceneServer/layers/0"
            });
            map.layers.add(GeosceneBygninger2Layer);

            /*

            const searchWidget = new Search({
                view: view
            });

            // Add the search widget to the top right corner of the view
            view.ui.add(searchWidget, {
                position: "top-right"
            });

            const energinettNettLayer = new WMSLayer({
                url: "https://agis.energinet.dk/server/services/INSPIRE/XP_el_Inspir/MapServer/WMSServer",
                sublayers: [
                    {
                        name: "0"
                    },
                    {
                        name: "1"
                    },
                    {
                        name: "2"
                    },
                    {
                        name: "3"
                    },
                ]
            });
            map.layers.add(energinettNettLayer);
            */

            /*
            // 
            // WMS lag over nordiske kraftnett
            // 
            const svkNettLayer = new WMSLayer({
                url: "https://inspire-skn.metria.se/geoserver/skn/wms",
                sublayers: [
                    {
                        name: "US.ElectricityNetwork.Lines"
                    },
                    {
                        name: "US.ElectricityNetwork.StationAreas"
                    },
                    {
                        name: "US.ElectricityNetwork.Stations"
                    }
                ]
            });
            map.layers.add(svkNettLayer);

            

            const energinettStationsLayer = new WMSLayer({
                url: "https://agis.energinet.dk/server/services/INSPIRE/WMS_WFS_TowerSubstationLine_N/MapServer/WMSServer",
                sublayers: [
                    {
                        name: "0"
                    }
                ]
            });
            map.layers.add(energinettStationsLayer);

            const statnettNettLayer = new WMSLayer({
                url: "https://nve.geodataonline.no/arcgis/services/Nettanlegg2/MapServer/WMSServer",
                sublayers: [
                    {
                        name: "Sjokabler"
                    },
                    {
                        name: "Distribusjonsnett"
                    },
                    {
                        name: "Regionalnett"
                    },
                    {
                        name: "Sentralnett"
                    },
                    {
                        name: "Transformatorstasjoner"
                    },
                    {
                        name: "Master og stolper"
                    },
                ]
            });
            map.layers.add(statnettNettLayer);

            // const fingridNettLayer = new WMSLayer({
            //    url: "https://fingrid.navici.com/wms/3d5805c1f9cda9db42d9d9378952427b",
            //    sublayers: [
            //        {
            //            name: "active_power_lines"
            //        },
            //        {
            //            name: "external_power_lines"
            //        },
            //        {
            //            name: "active_cables"
            //        },
            //        {
            //            name: "external_cables"
            //        },
            //        {
            //            name: "active_stations"
            //        },
            //        {
            //            name: "external_stations"
            //        },
            //    ]
            // });
            // map.layers.add(fingridNettLayer);

            var statnettKraftnettLayer = new SceneLayer({
                portalItem: {
                    id: "5ee88cca0f784547ae79e717960d7223"
                }
            });
            map.layers.add(statnettKraftnettLayer);

            

            // Create SceneLayer and add to the map
        const sceneLayer = new SceneLayer({
          portalItem: {
            id: "2e0761b9a4274b8db52c4bf34356911e"
          },
          popupEnabled: false
        });
        map.add(sceneLayer);

            // Create MeshSymbol3D for symbolizing SceneLayer
            const symbol = {
                type: "mesh-3d", // autocasts as new MeshSymbol3D()
                symbolLayers: [
                    {
                        type: "fill", // autocasts as new FillSymbol3DLayer()
                        // If the value of material is not assigned, the default color will be grey
                        material: {
                            color: [244, 247, 134]
                        }
                    }
                ]
            };
            // Add the renderer to sceneLayer
            sceneLayer.renderer = {
                type: "simple", // autocasts as new SimpleRenderer()
                symbol: symbol
            };
            */
        });

    </script>

</head>

<body data-new-gr-c-s-check-loaded="14.1062.0" data-gr-ext-installed>
    <!-- GjÃ¸r hele nettsiden til  -->
    <div id="dropZone"></div>
    <script>
        var dropZone = document.getElementById('dropZone');

        function showDropZone() {
            dropZone.style.visibility = "visible";
        }
        function hideDropZone() {
            dropZone.style.visibility = "hidden";
        }

        function allowDrag(e) {
            if (true) {  // Test that the item being dragged is a valid one
                e.dataTransfer.dropEffect = 'copy';
                e.preventDefault();
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            hideDropZone();

            alert('Drop!');
        }

        // 1
        window.addEventListener('dragenter', function (e) {
            showDropZone();
        });

        // 2
        dropZone.addEventListener('dragenter', allowDrag);
        dropZone.addEventListener('dragover', allowDrag);

        // 3
        dropZone.addEventListener('dragleave', function (e) {
            hideDropZone();
        });

        // 4
        dropZone.addEventListener('drop', handleDrop);
    </script>
    <div id="viewDiv"></div>
    <div id="topbar">
        <button
          class="action-button esri-icon-measure-line"
          id="distanceButton"
          type="button"
          title="Measure distance between two points"
        ></button>
        <button
          class="action-button esri-icon-measure-area"
          id="areaButton"
          type="button"
          title="Measure area"
        ></button>
      </div>
</body>

</html>